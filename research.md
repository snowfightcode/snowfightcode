# ADR: JavaScriptランタイムの選択

## ステータス

採用: 2025-11-24

## コンテキスト

Snowfight: Codeは、プレイヤーがJavaScriptでロジックを記述するプログラミングゲームです。このゲームの核となる価値は**リソース制約下でのプログラミング**であり、限られた計算資源（命令数・メモリ）の中で最適な戦略を実装することを目標とします。

### 要件

1. **決定論的実行**: PCの性能に関わらず、同じコードは常に同じ結果を生成する必要がある
2. **リソースカウント**: 命令数やメモリ使用量を正確に測定・制限できる
3. **安定性**: 本番環境でクラッシュしない
4. **ビルドの容易さ**: クロスコンパイルや開発環境のセットアップが複雑でない

## 検討した選択肢

### 1. dop251/goja (Pure Go JavaScript Engine)

**メリット:**
- Pure Goのため、Cgoが不要
- ビルドが簡単（`go build`のみ）
- クロスコンパイルが容易

**デメリット:**
- **決定論性の欠如**: タイムアウト制限しか設定できず、「1秒でタイムアウト」では高性能PCと低性能PCで実行できる命令数が大きく異なる
- リソースカウントが事実上不可能

**判定:** ❌ 却下（要件1, 2を満たさない）

### 2. lithdew/quickjs (Cgo版QuickJS)

**メリット:**
- QuickJSの機能をフルに利用可能
- 命令数カウント・メモリ制限が可能

**デメリット:**
- **実行時クラッシュ**: SIGSEGV/SIGBUSエラーが発生
- Cgoのメモリ管理の複雑さ
- スレッド制約によるデバッグの困難さ

**判定:** ❌ 却下（要件3を満たさない）

### 3. quickjs-go/quickjs-go (Cgo版QuickJS)

**メリット:**
- QuickJSの機能をフルに利用可能
- 活発に開発されている

**デメリット:**
- **リンクエラー**: 静的ライブラリがGoモジュールに含まれていない
- ビルド時に外部の静的ライブラリが必要

**判定:** ❌ 却下（要件4を満たさない）

### 4. buke/quickjs-go (Cgo版QuickJS)

**メリット:**
- 日本語ドキュメントあり
- 活発に開発されている

**デメリット:**
- **Cソースコード欠如**: `quickjs.h`等のCヘッダーファイルがパッケージに含まれていない
- gitサブモジュールでCソースを管理しているため、`go get`だけでは不完全

**判定:** ❌ 却下（要件4を満たさない）

### 5. fastschema/qjs (WASM版QuickJS) ✅

**メリット:**
- ✅ **Cgo不要**: Pure Goと同様にビルド可能
- ✅ **QuickJSの機能**: 命令数カウント・メモリ制限が実装可能
- ✅ **安定性**: WASMサンドボックス内で実行されるため、クラッシュのリスクが低い
- ✅ **クロスコンパイル容易**: WASMランタイム(Wazero)経由なので環境依存性がない
- ✅ **モダンな実装**: ES2023、async/awaitをサポート

**デメリット:**
- Pure Goより若干オーバーヘッドがある（しかし許容範囲内）

**判定:** ✅ **採用**（全要件を満たす）

## 決定事項

**fastschema/qjs (WASM版QuickJS)** を採用する。

### 理由

1. **全要件を満たす唯一の選択肢**: Cgo不要で安定しながら、QuickJSの機能（リソースカウント）を利用可能
2. **開発体験の向上**: Pure Goと同様にシンプルにビルドでき、Cgoのデバッグ問題を回避
3. **将来性**: QuickJSのアップデートに追従しやすく、WASMエコシステムの恩恵を受けられる

## 結果

### ポジティブ

- ビルドが`go build`のみで完結
- クロスコンパイルが容易（開発はMac、本番はLinuxなど）
- クラッシュのリスクが大幅に低減
- リソース制約の実装が可能（今後の拡張）

### ネガティブ

- WASMオーバーヘッドによる若干のパフォーマンス低下（測定していないが理論上存在）
- 新しいライブラリのため、長期的なメンテナンス状況は未知数

### ニュートラル

- pure Go (Goja) からの移行コストは発生したが、将来的な安定性とリソース制約実装のメリットが上回る

## 参考資料

- [fastschema/qjs GitHub](https://github.com/fastschema/qjs)
- [QuickJS公式サイト](https://bellard.org/quickjs/)
- [Wazero (WebAssembly Runtime)](https://github.com/tetratelabs/wazero)
